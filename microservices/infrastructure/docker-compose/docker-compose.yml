services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: crawlify
      POSTGRES_USER: crawlify
      POSTGRES_PASSWORD: dev_password
    ports:
      - "5433:5432"  # Changed from 5432 to avoid conflict
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crawlify"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PgBouncer - Connection pooler (50:1 multiplexing)
  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    environment:
      DATABASES_HOST: postgres
      DATABASES_PORT: 5432
      DATABASES_USER: crawlify
      DATABASES_PASSWORD: dev_password
      DATABASES_DBNAME: crawlify
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: 10000
      PGBOUNCER_DEFAULT_POOL_SIZE: 100
      PGBOUNCER_MIN_POOL_SIZE: 10
      PGBOUNCER_RESERVE_POOL_SIZE: 10
    ports:
      - "6432:6432"
    depends_on:
      postgres:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Changed from 6379 to avoid conflict
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  pubsub-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:emulators
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085
    ports:
      - "8095:8085"  # Changed from 8085 to avoid conflict
    environment:
      PUBSUB_PROJECT_ID: crawlify-local

  orchestrator:
    build:
      context: ../..
      dockerfile: orchestrator/Dockerfile
    ports:
      - "8090:8080"  # Changed from 8080 to avoid conflict
    environment:
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
      DATABASE_HOST: pgbouncer  # Use PgBouncer instead of direct postgres
      DATABASE_PORT: 6432
      DATABASE_USER: crawlify
      DATABASE_PASSWORD: dev_password
      DATABASE_NAME: crawlify
      REDIS_HOST: redis
      REDIS_PORT: 6379
      GCP_PROJECT_ID: crawlify-local
      GCP_PUBSUB_TOPIC: crawlify-tasks
      PUBSUB_EMULATOR_HOST: pubsub-emulator:8085
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      pubsub-emulator:
        condition: service_started
    restart: unless-stopped

  worker:
    build:
      context: ../..
      dockerfile: worker/Dockerfile
    ports:
      - "8091:8080"  # Changed from 8081 to avoid conflict
    environment:
      SERVER_PORT: 8080
      DATABASE_HOST: pgbouncer  # Use PgBouncer instead of direct postgres
      DATABASE_PORT: 6432
      DATABASE_USER: crawlify
      DATABASE_PASSWORD: dev_password
      DATABASE_NAME: crawlify
      REDIS_HOST: redis
      REDIS_PORT: 6379
      GCP_PROJECT_ID: crawlify-local
      GCP_PUBSUB_SUBSCRIPTION: crawlify-tasks-sub
      GCP_STORAGE_BUCKET: crawlify-extractions
      PUBSUB_EMULATOR_HOST: pubsub-emulator:8085
      ORCHESTRATOR_URL: http://orchestrator:8080
      BROWSER_HEADLESS: "true"
      BROWSER_POOL_SIZE: 3
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      pubsub-emulator:
        condition: service_started
      orchestrator:
        condition: service_started
    restart: unless-stopped
    # Increase shared memory for Chromium
    shm_size: 2gb

volumes:
  postgres_data:
